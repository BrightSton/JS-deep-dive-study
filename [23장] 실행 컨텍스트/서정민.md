23장 실행 컨텍스트

자바스크립트의 동작 원리를 담고 있는 핵심개념임

> 💡 실행 컨텍스트의 필요성
- 선언에 의해 생성된 모든 식별자를 스코프를 구분하여 등록하고 상태 변화를 지속적으로 관리할 수 있어야 한다.
- 스코프는 중첩 관계에 의해 스코프 체인을 형성해야 한다. 스코프 체인을 통해 상위 스코프로 이동해 검색할 수 있어야 한다.
- 현재 실행 중인 코드의 실행 순서를 변경할 수 있어야 한다. 다시 되돌아 가는것도 가능해야 한다. 

> 💡 실행 컨텍스트의 구성

전역 실행 컨텍스트
- 전역 렉시컬 환경
   - 전역 환경 레코드
      - 객체 환경 레코드
        - 선언적 환경 레코드
   - this 바인딩
   - 외부 렉시컬 환경 참조

함수 실행 컨텍스트
   - 함수 렉시컬 환경
     - 함수 환경 레코드
     - this 바인딩
     - 외부 렉시컬 환경 참조

## 소스코드의 타입
소스코드의 타입 4가지
1. > #### 전역코드 (global code)
   > - 전역에 존재하는 소스코드
   > - 전역의 정의된 함수, 클래스 등의 내부 코드는 포함되지 않음
   > - 이를 위해 `전역 코드`가 평가되면 `전역 실행 컨텍스트`가 생성됨

2. > #### 함수코드 (function code)
   > - 함수 내부에 존재하는 소스코드
   > - 함수 내부에 중첩된 함수, 클래스 등의 내부 코드는 포함되지 않음
   > - 지역 스코프를 생성하고 지역 변수, 매개변수, `arguments 객체`를 관리해야함
   > - 생성한 지역 스코프를 전역 스코프에서 시작하는 스코프 체인의 일원으로 연결해야함
   > - 이를 위해 `함수 코드`가 평가되면 `함수 실행 컨텍스트`가 생성됨

3. > #### eval 코드 (eval code)
   > - 빌트인 전역 함수인 eval 함수에 인수로 전달되어 실행되는 소스코드
   > - `strict mode` 엄격 모드에서 자신만의 독자적인 스코프를 생성함
   > - 이를 위해 `eval 코드`가 평가되면 `eval 실행 컨텍스트`가 생성됨

4. > #### 모듈 코드 (module code)
   > - 모듈 내부에 존재하는 소스코드
   > - 모듈 내부에 중첩된 함수, 클래스 등의 내부 코드는 포함되지 않음
   > - 모듈별로 독립적인 모듈 스코프를 생성함
   > - 이를 위해 `모듈 코드`가 평가되면 `모듈 실행 컨텍스트`가 생성됨


## 소스코드의 평가와 실행
자바스크립트 엔진의 소스코드 과정
1. > #### 소스코드 평가
   > - 실행 컨텍스트를 생성
   > - 변수, 함수 등의 선언문을 실행
   > - 생성된 변수나 함수 식별자를 키로 실행

2. 소스코드 실행
   > - `런타임`: 선언문을 제외한 소스코드가 순차적으로 실행됨
   > - 실행에 필요한 정보(변수나 함수의 참조)를 실행 컨텍스트가 관리하는 스코프에서 검색해서 취득함


```javascript
var x;
x= 1;
```
1. 소스코드 평가
   - 변수 선언문 `var x;` 실행
   - 식별자 x를 실행 컨텍스트가 관리하는 스코프에 등록하고 `undefined`로 초기화
   
2. 소스코드 실행
   - 변수 할당문 `x = 1;` 실행
   - 변수 객체에서 x가 선언되었는지 검색하고 취득
   - x에 1을 할당
   - 할당 결과를 실행 컨텍스트에 등록하여 관리


## 실행 컨텍스트의 역할
```javascript
// 전역 변수 선언
const x = 1;
const y = 2;

// 함수 정의
function foo(a) {
  // 지역 변수 선언
  const x = 10;
  const y = 20;

  // 메서드 호출
  console.log(a + x + y); // 130
}

// 함수 호출
foo(100);

// 메서드 호출
console.log(x + y); // 3
```
#### 1. 전역 코드 평가
- 전역 코드를 실행하기 전에 전역 코드 평가 과정을 거쳐 준비를 한다.
- 선언문만 먼저 실행한다.const x; const y;
- 생성된 전역 변수와 전역 함수가 실행 컨텍스트가 관리하는 전역 스코프에 등록된다.
- 이때 var키워드로 선언된 전역 변수와 함수 선언문으로 정의된 전역 함수는 전역 객체의 프로퍼티와 메서드가 된다.(브라우저는 `window`객체의 프로퍼티와 메서드가 된다.)

#### 2. 전역 코드 실행
- 평가 과정이 끝나면 런타임이 시작되어 코드가 순차적으로 실행된다.
- 전역 변수에 값이 할당되고 함수가 호출된다.x = 1; y = 1;
- 함수가 호출되면 전역코드의 실행을 중단하고 코드 실행 순서를 변경하여 함수 내부로 진입한다.foo(100);

#### 3. 함수 코드 평가
- 함수 내부로 진입하면 내부의 문들을 실행하기 전에 함수 코드 평가 과정을 거치며 준비한다.
- 매개변수(a)와 지역 변수 선언문이const x; const y; 먼저 실행되고 실행 컨텍스트가 관리하는 지역 스코프에 등록된다.
- `arguments`객체가 생성되어 지역 스코프에 등록되고, this바인딩도 결정된다.

#### 4. 함수 코드 실행
- 평가 과정이 끝나면 런타임이 시작되어 코드가 순차적으로 실행된다.
- 매개변수와 지역 변수에 값이 할당`x = 10; y = 10;`되고 `console.log(a + x + y);`메서드가 호출된다. 
- `console`식별자는 스코프 체인을 통해 검색한다.(현재 스코프에 없으면 상위 스코프로 올라가서 검색)


## 실행 컨텍스트 스택
`실행 컨텍스트 스택`: 코드의 실행 순서를 관리함

실행 컨텍스트를 관리하는 자료구조로, 실행 컨텍스트가 생성되면 스택에 쌓이고 실행이 종료되면 스택에서 제거된다.

```javascript
const x = 1;

function foo () {
  const y = 2;

  function bar () {
    const z = 3;
    console.log(x + y + z);
  }
  bar();
}

foo(); // 6
```
1. 전역 코드의 평가와 실행
   - 전역 코드를 평가하여 전역 실행 컨텍스트를 생성하고 실행 컨텍스트 스택에 푸시
   - 이때 전역 변수 x와 전역 함수 foo는 전역 실행 컨텍스트에 등록
   - 이후 전역 코드가 실행되어 전역 변수 x에 값이 할당되고 전역 함수 foo가 호출

2. `foo`함수 코드의 평가와 실행
   - foo함수가 호출되면 전역 코드의 실행은 중단되고 제어권이 foo함수 내부로 이동
   - foo함수 내부의 함수 코드를 평가하여 foo함수 실행 컨텍스트를 생성하고 실행 컨텍스트 스택에 푸시
   - 이때 지역변수 y와 중첩함수 bar가 foo함수 실행 컨텍스트에 등록
   - 이후 foo함수 코드가 실행되어 지역변수y에 값이 할당되고 중첩함수 bar가 호출

3. `bar`함수 코드의 평가와 실행
   - foo함수 코드의 실행은 일시 중단되고 제어권이 bar함수 내부로 이동
   - bar함수 코드를 평가하여 bar함수 시행 컨텍스트를 생성하고 실행 컨텍스트 스택에 푸시
   - 이때 bar함수의 지역변수z가 bar함수 실행 컨텍스트에 등록
   - 이후 bar함수가 실행되어 z에 값이 할당되고 console.log메서드를 호출 한 이후 bar함수는 종료

4. `foo`함수코드로 복귀
   - bar함수가 종료되면 제어권은 다시 foo함수로 이동
   - bar함수 실행 컨텍스트를 스택에서 팝하여 제거
   - foo함수 종료

5. 전역 코드로 복귀
   - foo함수가 종료되면 제어권은 다시 전역 코드로 이동
   - 더이상 실행할 전역코드가 없어 전역 실행 컨텍스트도 스택에서 팝하여 제거

> 💡 실행 중인 실행 컨텍스트 `running execution context`
> - 실행 컨텍스트의 최상위에 존재하는 실행 컨텍스트, 현재 실행 중인 코드의 실행 컨텍스트
> - 현재 실행 중인 함수의 지역 변수, 매개변수, `this 바인딩, `외부 렉시컬 환경 참조`를 포함함
> - 실행 컨텍스트 스택에서 함수 호출이 발생하며느 새로운 함수의 실행 컨텍스트가 스택에 푸시되어 현재 실행중인 컨텍스트가 됨
> - 함수 실행이 종료되면 해당 함수의 실행 컨텍스트는 스택에서 팝 되어 제거되고, 제어권은 이전의 실행 컨텍스트(호출자)에게 돌아감
> - 이 과정을 통해 자바스크립트 엔진은 코드의 실행 순서와 스코프 관리를 효율적으로 수행함


## 렉시컬 환경
`렉시컬 환경`: 스코프와 식별자를 관리함

식별자와 식별자에 바인딩된 값, 상위 스코프에 대한 참조를 기록하는 자료구조

`렉시컬 환경`은 `환경 레코드`와 `외부 렉시컬 환경 참조`로 구성된다.

1. 환경 레코드
   - 스코프에 포함된 식별자를 등록하고 등록된 식별자에 바인딩된 값을 관리하는 저장소.
   - 환경 레코드는 소스코드의 타입에 따라 관리하는 내용에 차이가 있다.
2. 외부 렉시컬 환경 참조
   - 상위 스코프를 가리킨다.
   - 해당 실행 컨텍스트를 생성한 소스코드를 포함하는 상위 코드의 렉시컬 환경
   - 단방향 링크드 리스트인 스코프체인을 구현한다.


## 실행 컨텍스트의 생성과 식별자 검색 과정
### 전역 객체 생성
### 전역 코드 평가
### 전역 코드 실행
### foo 함수 코드 평가
### foo 함수 코드 실행
### bar 함수 코드 평가
### bar 함수 코드 실행
### bar 함수 코드 실행 종료
### foo 함수 코드 실행 종료
### 전역 코드 실행 종료

## 실행 컨텍스트와 블록 레벨 스코프